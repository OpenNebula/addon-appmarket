#!/usr/bin/env ruby

ONE_LOCATION = ENV["ONE_LOCATION"]

if !ONE_LOCATION
    LOG_LOCATION = "/var/log/one"
    ETC_LOCATION = "/etc/one"
    RUBY_LIB_LOCATION = "/usr/lib/one/ruby"
else
    LOG_LOCATION = ONE_LOCATION + "/var"
    ETC_LOCATION = ONE_LOCATION + "/etc"
    RUBY_LIB_LOCATION = ONE_LOCATION+"/lib/ruby"
end

CONFIGURATION_FILE   = ETC_LOCATION + "/appconverter-worker.conf"

$: << RUBY_LIB_LOCATION + '/appconverter'
$: << RUBY_LIB_LOCATION + '/appconverter/lib'

################################################################################
# Libraries
################################################################################

require 'appmarket_client'
require 'ovf_parser_opennebula'
require 'appliance'

require 'rubygems'
require 'json'
require 'base64'
require 'yaml'
require 'tmpdir'
require 'fileutils'
require 'open4'
require 'uuidtools'
require 'digest/md5'
require 'digest/sha1'

require 'pp'

################################################################################
# Configuration
################################################################################

begin
    CONF = YAML.load_file(CONFIGURATION_FILE)
rescue Exception => e
    STDERR.puts "Error parsing config file #{CONFIGURATION_FILE}: #{e.message}"
    exit 1
end

################################################################################
# Helper Methods
################################################################################

def fail(error)
    STDERR.puts "Error: #{error}."
    # TODO: client error
    exit 1
end

def ensure_value(value, error_msg)
    fail(error_msg) if value.nil? or value.empty?
end

################################################################################
# Main
################################################################################

# Callback URL
callback_url = ARGV[0]

# Job meta-data
begin
    job_json = JSON.parse(Base64::decode64(ARGV[1]))
rescue
    fail("Invalid job.")
end

username = CONF[:username]
password = CONF[:password]
url      = CONF[:url]

$client = AppMarket::Client.new(username, password, url)

source      = job_json["appliance"]["source"]
source_type = job_json["appliance"]["source_type"]

ensure_value(source,      "Attribute 'source' cannot be empty.")
ensure_value(source_type, "Attribute 'source_type' cannot be empty.")

case source_type
when "ova" then klass = OVA
else
    fail("unknown type #{type}")
end

appliance = klass.new(job_json["appliance"])

appliance.unpack
appliance.register_files

job_json["appliance"] = appliance.to_hash

$client.callback(callback_url, "done", job_json.to_json)
